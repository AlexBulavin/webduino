<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta http-equiv="Access-Control-Allow-Headers" content="Origin, X-Requested-With, Content-Type, Accept">
        <meta http-equiv="Access-Control-Allow-Methods" content="GET,POST,PUT,DELETE,OPTIONS">
        <meta http-equiv="Access-Control-Allow-Origin" content="*">
        <title>Webbit MQTT</title>
        <script src="https://blocklypro.webduino.io/components/jquery/dist/jquery.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/lib/webduino-all-0.4.20.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/webduino-blockly.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/lib/firebase.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/lib/runtime.min.js"></script>
        <script src="https://blocklypro.webduino.io/node_modules/webduino-module-mqtt/mqttClient.min.js"></script>
    </head>
    <body>

    <script>
      
    </script>
    Send Topic:
    <input type="text" id="sendTopic">
    <br>
    <input type="text" id="mqtt">
    <input type="checkbox" id="chkSend" style="display:none">
    <input type="button" value="send" onclick="document.getElementById('chkSend').checked=true;">
    <br>
    Get Topic:
    <input type="text" id="getTopic">
    <br>
    <div id="receive" style="color:red;"></div>

    <script>
      (async function () {      
        if (!webduinoBroadcastor) {
          var webduinoBroadcastor = new webduino.module.mqttClient();
          await webduinoBroadcastor.connect({ server: 'wss://mqtt1.webduino.io/mqtt' });
        }
        var msg = "";
        var msg_last = "";
        var sendTopic = "";
        setInterval(async function () {
          sendTopic = document.getElementById('sendTopic').value;
          if (sendTopic=="") return;
          msg = document.getElementById('mqtt').value;
          if (document.getElementById('chkSend').checked==true&&sendTopic!=""&&msg!="") {
            document.getElementById('mqtt').value="";
            if (msg==msg_last) return;
            msg_last=msg;
            if (webduinoBroadcastor) {
              document.getElementById('chkSend').checked=false;
              webduinoBroadcastor.send({topic: sendTopic, message: msg});
            }
          }
        }, 100);
        setInterval(async function () {
          getTopic = document.getElementById('getTopic').value;
          if (getTopic=="") return;
          await webduinoBroadcastor.onMessage(getTopic, async (message) => {
            console.log(message);
            document.getElementById('receive').innerHTML = message;
          });
        }, 100);        
      }());
    </script>      
    </body>
</html>
