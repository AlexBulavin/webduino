<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta http-equiv="Access-Control-Allow-Headers" content="Origin, X-Requested-With, Content-Type, Accept">
        <meta http-equiv="Access-Control-Allow-Methods" content="GET,POST,PUT,DELETE,OPTIONS">
        <meta http-equiv="Access-Control-Allow-Origin" content="*">
        <title>Webbit MQTT</title>
        <script src="https://blocklypro.webduino.io/components/jquery/dist/jquery.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/lib/webduino-all-0.4.20.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/webduino-blockly.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/lib/firebase.min.js"></script>
        <script src="https://blocklypro.webduino.io/dist/lib/runtime.min.js"></script>
        <script src="https://blocklypro.webduino.io/node_modules/webduino-module-mqtt/mqttClient.min.js"></script>
        <style>
          input[type="button"]{
            padding:1px 1px;
            border:1px black solid;
            cursor:pointer;
            -webkit-border-radius: 5px;
            border-radius: 3px; 
          }
          input[type="text"]{
            border:1px black solid;
            border-radius: 3px; 
          }          
        </style>
    </head>
    <body>
    <font color="green" size="6">Webduino MQTT</font>
    <br>
    <table>
      <tr><td>Send-Topic:</td><td><input type="text" id="sendTopic"></td></tr>
      <tr><td>Message:</td><td><input type="text" id="mqtt"></td></tr>
      <tr><td></td><td><input type="button" value="send" onclick="sendMessage();"></td></tr> 
      <tr><td></td><td></td></tr>            
      <tr><td>Get-Topic:</td><td><input type="text" id="getTopic"></td></tr>          
    </table>
    <div id="receive" style="color:red;"></div>
    <br>
    
    
    <br>
    <br>
    
    
    <br>
    

    <script>
      var webduinoBroadcastor;    
      (async function () {      
        if (!webduinoBroadcastor) {
          webduinoBroadcastor = new webduino.module.mqttClient();
          await webduinoBroadcastor.connect({ server: 'wss://mqtt1.webduino.io/mqtt' });  
        }
      }());

      async function sendMessage() {
        if (!webduinoBroadcastor) {
          document.getElementById('receive').innerHTML = "Connected to server failed.";
          return;
        }
        document.getElementById('receive').innerHTML = "";
        var sendTopic = document.getElementById('sendTopic').value;
        var msg = document.getElementById('mqtt').value;
        if (sendTopic==""||msg=="") return; 
        document.getElementById('mqtt').value="";
        if (webduinoBroadcastor) {
          webduinoBroadcastor.send({topic: sendTopic, message: msg});
        }
      }  
      
      setInterval(async function () {
        var getTopic = document.getElementById('getTopic').value;
        if (getTopic=="") return;
        await webduinoBroadcastor.onMessage(getTopic, async (message) => {
          //console.log(message);
          document.getElementById('receive').innerHTML = message;
        });
      }, 100);        
    </script>      
    </body>
</html>
