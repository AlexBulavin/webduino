<!-- 
Author : ChungYi Fu (Kaohsiung, Taiwan)   2020/2/9 23:00
https://www.facebook.com/francefu

Color List
https://en.wikipedia.org/wiki/Web_colors

Try it!
https://fustyles.github.io/webduino/Tracking.js/tracking.js_DetectMask_video.html
-->
<!doctype html>
<html>
<head>
  <title>tracking.js - color with camera</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://fustyles.github.io/webduino/Tracking_20190917/tracking-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.4"> </script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"> </script> 
</head>
<body>
<video id="video" width="320" height="240" style="visibility:hidden;position:absolute" preload autoplay loop muted></video>
<canvas id="canvas"></canvas><canvas id="canvas_custom"></canvas><br>
<table>
<tr>
  <td>Rect(Red)</td>
  <td>
  <select id="myColor" onchange="changeColor(this.options[this.selectedIndex].text);startDetect();">
	<option value="AliceBlue">AliceBlue_240,248,255</option>
	<option value="AntiqueWhite">AntiqueWhite_250,235,215</option>
	<option value="Aqua">Aqua_0,255,255</option>
	<option value="Aquamarine">Aquamarine_127,255,212</option>
	<option value="Azure">Azure_240,255,255</option>
	<option value="Beige">Beige_245,245,220</option>
	<option value="Bisque">Bisque_255,228,196</option>
	<option value="Black">Black_0,0,0</option>
	<option value="BlanchedAlmond">BlanchedAlmond_255,235,205</option>
	<option value="Blue">Blue_0,0,255</option>
	<option value="BlueViolet">BlueViolet_138,43,226</option>
	<option value="Brown">Brown_165,42,42</option>
	<option value="Burlywood">Burlywood_222,184,135</option>
	<option value="CadetBlue">CadetBlue_95,158,160</option>
	<option value="Chartreuse">Chartreuse_127,255,0</option>
	<option value="Chocolate">Chocolate_210,105,30</option>
	<option value="Coral">Coral_255,127,80</option>
	<option value="CornflowerBlue">CornflowerBlue_100,149,237</option>
	<option value="Cornsilk">Cornsilk_255,248,220</option>
	<option value="Crimson">Crimson_220,20,60</option>
	<option value="Cyan">Cyan_0,255,255</option>
	<option value="DarkBlue">DarkBlue_0,0,139</option>
	<option value="DarkCyan">DarkCyan_0,139,139</option>
	<option value="DarkGoldenrod">DarkGoldenrod_184,134,11</option>
	<option value="DarkGray">DarkGray_169,169,169</option>
	<option value="DarkGreen">DarkGreen_0,100,0</option>
	<option value="DarkKhaki">DarkKhaki_189,183,107</option>
	<option value="DarkMagenta">DarkMagenta_139,0,139</option>
	<option value="DarkOliveGreen">DarkOliveGreen_85,107,47</option>
	<option value="DarkOrange">DarkOrange_255,140,0</option>
	<option value="DarkOrchid">DarkOrchid_153,50,204</option>
	<option value="DarkRed">DarkRed_139,0,0</option>
	<option value="DarkSalmon">DarkSalmon_233,150,122</option>
	<option value="DarkSeaGreen">DarkSeaGreen_143,188,143</option>
	<option value="DarkSlateBlue">DarkSlateBlue_72,61,139</option>
	<option value="DarkSlateGray">DarkSlateGray_47,79,79</option>
	<option value="DarkTurquoise">DarkTurquoise_0,206,209</option>
	<option value="DarkViolet">DarkViolet_148,0,211</option>
	<option value="DeepPink">DeepPink_255,20,147</option>
	<option value="DeepSkyBlue">DeepSkyBlue_0,191,255</option>
	<option value="DimGray">DimGray_105,105,105</option>
	<option value="DodgerBlue">DodgerBlue_30,144,255</option>
	<option value="Firebrick">Firebrick_178,34,34</option>
	<option value="FloralWhite">FloralWhite_255,250,240</option>
	<option value="ForestGreen">ForestGreen_34,139,34</option>
	<option value="Fuchsia">Fuchsia_255,0,255</option>
	<option value="Gainsboro">Gainsboro_220,220,220</option>
	<option value="GhostWhite">GhostWhite_248,248,255</option>
	<option value="Gold">Gold_255,215,0</option>
	<option value="Goldenrod">Goldenrod_218,165,32</option>
	<option value="Gray">Gray_128,128,128</option>
	<option value="Green">Green_0,128,0</option>
	<option value="GreenYellow">GreenYellow_173,255,47</option>
	<option value="Honeydew">Honeydew_240,255,240</option>
	<option value="HotPink">HotPink_255,105,180</option>
	<option value="IndianRed">IndianRed_205,92,92</option>
	<option value="Indigo">Indigo_75,0,130</option>
	<option value="Ivory">Ivory_255,255,240</option>
	<option value="Khaki">Khaki_240,230,140</option>
	<option value="Lavender">Lavender_230,230,250</option>
	<option value="LavenderBlush">LavenderBlush_255,240,245</option>
	<option value="LawnGreen">LawnGreen_124,252,0</option>
	<option value="LemonChiffon">LemonChiffon_255,250,205</option>
	<option value="LightBlue">LightBlue_173,216,230</option>
	<option value="LightCoral">LightCoral_240,128,128</option>
	<option value="LightCyan">LightCyan_224,255,255</option>
	<option value="LightGoldenrodYellow">LightGoldenrodYellow_250,250,210</option>
	<option value="LightGray">LightGray_211,211,211</option>
	<option value="LightGreen">LightGreen_144,238,144</option>
	<option value="LightPink">LightPink_255,182,193</option>
	<option value="LightSalmon">LightSalmon_255,160,122</option>
	<option value="LightSeaGreen">LightSeaGreen_32,178,170</option>
	<option value="LightSkyBlue">LightSkyBlue_135,206,250</option>
	<option value="LightSlateGray">LightSlateGray_119,136,153</option>
	<option value="LightSteelBlue">LightSteelBlue_176,196,222</option>
	<option value="LightYellow">LightYellow_255,255,224</option>
	<option value="Lime">Lime_0,255,0</option>
	<option value="LimeGreen">LimeGreen_50,205,50</option>
	<option value="Linen">Linen_250,240,230</option>
	<option value="Magenta">Magenta_255,0,255</option>
	<option value="Maroon">Maroon_128,0,0</option>
	<option value="MediumAquamarine">MediumAquamarine_102,205,170</option>
	<option value="MediumBlue">MediumBlue_0,0,205</option>
	<option value="MediumOrchid">MediumOrchid_186,85,211</option>
	<option value="MediumPurple">MediumPurple_147,112,219</option>
	<option value="MediumSeaGreen">MediumSeaGreen_60,179,113</option>
	<option value="MediumSlateBlue">MediumSlateBlue_123,104,238</option>
	<option value="MediumSpringGreen">MediumSpringGreen_0,250,154</option>
	<option value="MediumTurquoise">MediumTurquoise_72,209,204</option>
	<option value="MediumVioletRed">MediumVioletRed_199,21,133</option>
	<option value="MidnightBlue">MidnightBlue_25,25,112</option>
	<option value="MintCream">MintCream_245,255,250</option>
	<option value="MistyRose">MistyRose_255,228,225</option>
	<option value="Moccasin">Moccasin_255,228,181</option>
	<option value="NavajoWhite">NavajoWhite_255,222,173</option>
	<option value="Navy">Navy_0,0,128</option>
	<option value="OldLace">OldLace_253,245,230</option>
	<option value="Olive">Olive_128,128,0</option>
	<option value="OliveDrab">OliveDrab_107,142,35</option>
	<option value="Orange">Orange_255,165,0</option>
	<option value="OrangeRed">OrangeRed_255,69,0</option>
	<option value="Orchid">Orchid_218,112,214</option>
	<option value="PaleGoldenrod">PaleGoldenrod_238,232,170</option>
	<option value="PaleGreen">PaleGreen_152,251,152</option>
	<option value="PaleTurquoise">PaleTurquoise_175,238,238</option>
	<option value="PaleVioletRed">PaleVioletRed_219,112,147</option>
	<option value="PapayaWhip">PapayaWhip_255,239,213</option>
	<option value="PeachPuff">PeachPuff_255,218,185</option>
	<option value="Peru">Peru_205,133,63</option>
	<option value="Pink">Pink_255,192,203</option>
	<option value="Plum">Plum_221,160,221</option>
	<option value="PowderBlue">PowderBlue_176,224,230</option>
	<option value="Purple">Purple_128,0,128</option>
	<option value="Red">Red_255,0,0</option>
	<option value="RosyBrown">RosyBrown_188,143,143</option>
	<option value="RoyalBlue">RoyalBlue_65,105,225</option>
	<option value="SaddleBrown">SaddleBrown_139,69,19</option>
	<option value="Salmon">Salmon_250,128,114</option>
	<option value="SandyBrown">SandyBrown_244,164,96</option>
	<option value="SeaGreen">SeaGreen_46,139,87</option>
	<option value="Seashell">Seashell_255,245,238</option>
	<option value="Sienna">Sienna_160,82,45</option>
	<option value="Silver">Silver_192,192,192</option>
	<option value="SkyBlue">SkyBlue_135,206,235</option>
	<option value="SlateBlue">SlateBlue_106,90,205</option>
	<option value="SlateGray">SlateGray_112,128,144</option>
	<option value="Snow">Snow_255,250,250</option>
	<option value="SpringGreen">SpringGreen_0,255,127</option>
	<option value="SteelBlue">SteelBlue_70,130,180</option>
	<option value="Tan">Tan_210,180,140</option>
	<option value="Teal">Teal_0,128,128</option>
	<option value="Thistle">Thistle_216,191,216</option>
	<option value="Tomato">Tomato_255,99,71</option>
	<option value="Turquoise">Turquoise_64,224,208</option>
	<option value="Violet">Violet_238,130,238</option>
	<option value="Wheat">Wheat_245,222,179</option>
	<option value="White">White_255,255,255</option>
	<option value="WhiteSmoke">WhiteSmoke_245,245,245</option>
	<option value="Yellow">Yellow_255,255,0</option>
	<option value="YellowGreen">YellowGreen_154,205,50</option>
  </select>
  </td>
</tr>
<tr>
  <td align="right">R</td>
  <td>min<input type="range" id="myColor_r_min" min="0" max="255" step="1" onchange="myColor_r_min_v.innerHTML=this.value;startDetect();"><span id="myColor_r_min_v">0</span><br>
	  max<input type="range" id="myColor_r_max" min="0" max="255" step="1" onchange="myColor_r_max_v.innerHTML=this.value;startDetect();"><span id="myColor_r_max_v">0</span>
  </td>
</tr>
<tr>
  <td align="right">G</td>
  <td>min<input type="range" id="myColor_g_min" min="0" max="255" step="1" onchange="myColor_g_min_v.innerHTML=this.value;startDetect();"><span id="myColor_g_min_v">0</span><br>
	  max<input type="range" id="myColor_g_max" min="0" max="255" step="1" onchange="myColor_g_max_v.innerHTML=this.value;startDetect();"><span id="myColor_g_max_v">0</span>
  </td>
</tr>
<tr>
  <td align="right">B</td>
  <td>min<input type="range" id="myColor_b_min" min="0" max="255" step="1" onchange="myColor_b_min_v.innerHTML=this.value;startDetect();"><span id="myColor_b_min_v">0</span><br>
	  max<input type="range" id="myColor_b_max" min="0" max="255" step="1" onchange="myColor_b_max_v.innerHTML=this.value;startDetect();"><span id="myColor_b_max_v">0</span>
  </td>
</tr>
</table>
<button id="start" onclick="startDetect();" diasbled="true">Start Detection</button>
<div id="result" style="color:red"><div>

  <script>
    var video = document.getElementById('video');
    var start = document.getElementById('start');	  
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    var canvas_custom = document.getElementById('canvas_custom');
    var context_custom = canvas_custom.getContext('2d');
    var result = document.getElementById('result');
    var myColor_r_min,myColor_r_max,myColor_g_min,myColor_g_max,myColor_b_min,myColor_b_max;


    var Model;
	var nose = [];
	var state = "";
	posenet.load().then(function(net) {
	  Model = net;
      result.innerHTML = "PoseNet Model loaded successfully.";
	  start.disabled=false;
	}); 

    var tracker = new tracking.ColorTracker();
    tracking.track('#video', tracker, { camera: true });

    //初始化偵測顏色
    document.getElementById('myColor').value = "Green";
    document.getElementById('myColor_r_min').value = 118;
    document.getElementById('myColor_r_min_v').innerHTML = 118;
    document.getElementById('myColor_r_max').value = 164;
    document.getElementById('myColor_r_max_v').innerHTML = 164;
    document.getElementById('myColor_g_min').value = 128;
    document.getElementById('myColor_g_min_v').innerHTML = 128;
    document.getElementById('myColor_g_max').value = 221;
    document.getElementById('myColor_g_max_v').innerHTML = 221;
    document.getElementById('myColor_b_min').value = 177;
    document.getElementById('myColor_b_min_v').innerHTML = 177;
    document.getElementById('myColor_b_max').value = 216;
    document.getElementById('myColor_b_max_v').innerHTML = 216;
  
    function changeColor(detectColor) {
      var val = detectColor.split("_");
      document.getElementById('myColor_r_min').value = val[1].split(",")[0];
      document.getElementById('myColor_r_min_v').innerHTML = val[1].split(",")[0];
      document.getElementById('myColor_r_max').value = val[1].split(",")[0];
      document.getElementById('myColor_r_max_v').innerHTML = val[1].split(",")[0];
      document.getElementById('myColor_g_min').value = val[1].split(",")[1];
      document.getElementById('myColor_g_min_v').innerHTML = val[1].split(",")[1];
      document.getElementById('myColor_g_max').value = val[1].split(",")[1];
      document.getElementById('myColor_g_max_v').innerHTML = val[1].split(",")[1];
      document.getElementById('myColor_b_min').value = val[1].split(",")[2];
      document.getElementById('myColor_b_min_v').innerHTML = val[1].split(",")[2];
      document.getElementById('myColor_b_max').value = val[1].split(",")[2];
      document.getElementById('myColor_b_max_v').innerHTML = val[1].split(",")[2];
    }   


    function startDetect() {
      canvas.setAttribute("width", video.width);
      canvas.setAttribute("height", video.height);
      canvas_custom.setAttribute("width", video.width);
      canvas_custom.setAttribute("height", video.height);	    

      myColor_r_min = document.getElementById('myColor_r_min').value;
      myColor_r_max = document.getElementById('myColor_r_max').value;
      myColor_g_min = document.getElementById('myColor_g_min').value;
      myColor_g_max = document.getElementById('myColor_g_max').value;
      myColor_b_min = document.getElementById('myColor_b_min').value;
      myColor_b_max = document.getElementById('myColor_b_max').value;

	  tracking.ColorTracker.registerColor('red', function(r, g, b) {
	    if ((r>=myColor_r_min&&r<=myColor_r_max)&&(g>=myColor_g_min&&g<=myColor_g_max)&&(b>=myColor_b_min&&b<=myColor_b_max)) {
	  	  return true;
	    }
	    return false;
	  });

		var trackedColors = {
			custom: true
		};

		Object.keys(tracking.ColorTracker.knownColors_).forEach(function(color) {
			trackedColors[color] = true;
		});

		function updateColors() {
			var colors = [];

			for (var color in trackedColors) {
			  if (trackedColors[color]) {
				colors.push(color);
			  }
			}

			tracker.setColors(colors);
		}

		updateColors();


      tracker.on('track', function(event) {
        context.drawImage(video,0,0,video.width,video.height);
		result.innerHTML = "";

		var imgData=context.getImageData(0,0,canvas.width,canvas.height);
		for (var i=0;i<imgData.data.length;i+=4)
		  {
			if ((imgData.data[i]>=myColor_r_min&&imgData.data[i]<=myColor_r_max)&&(imgData.data[i+1]>=myColor_g_min&&imgData.data[i+1]<=myColor_g_max)&&(imgData.data[i+2]>=myColor_b_min&&imgData.data[i+2]<=myColor_b_max)) {
			  imgData.data[i]=0;
			  imgData.data[i+1]=0;
			  imgData.data[i+2]=0;
			  imgData.data[i+3]=255;
			}
			else {
			  imgData.data[i]=255;
			  imgData.data[i+1]=255;
			  imgData.data[i+2]=255;
			  imgData.data[i+3]=255;
			}
		  }
		context_custom.putImageData(imgData,0,0);

		DetectImage(canvas);
		state = "No mask";
		
        event.data.forEach(function(rect) {
		  //console.log(rect);
          context.strokeStyle = rect.color;
          context.strokeRect(rect.x, rect.y, rect.width, rect.height);
          //context.font = '11px Helvetica';
          //context.fillStyle = "#fff";
          //context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
          //context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);

		  result.innerHTML+= rect.color+","+rect.x+","+rect.y+","+rect.width+","+rect.height+"<br>";

		  if ((rect.color=="red")&&(nose[0]>=rect.x)&&(nose[0]<=(rect.x+rect.width))&&(nose[1]>=rect.y)&&(nose[1]<=(rect.y+rect.height))) {
			state = "Wear mask";
		  }
		  else if (rect.color=="red") {
			if (state != "Wear mask") state = "Not wear mask";
		  }

        });
		result.innerHTML = state + "<br><br>" + "nose,"+ nose + "<br>" +result.innerHTML;
      });
    };

	function DetectImage(canvas) {
	  Model.estimateSinglePose(canvas, {flipHorizontal: false}).then(pose => {
		if (pose.keypoints.length>0) {
			var part = pose.keypoints[0].part;
			const x = Math.round(pose.keypoints[0].position.x*100)/100;
			const y = Math.round(pose.keypoints[0].position.y*100)/100;
			nose = [];
			nose.push(x);
			nose.push(y);
		}
		else
		  nose = [-1,-1];
	  });
	}

  </script>
</body>
</html>
