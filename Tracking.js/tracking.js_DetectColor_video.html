<!-- 
Author : ChungYi Fu (Kaohsiung, Taiwan)   2020/2/2 11:00
https://www.facebook.com/francefu

Color List
https://htmlcolorcodes.com/color-names/

Try it!
https://fustyles.github.io/webduino/Tracking.js/tracking.js_DetectColor_video.html
-->
<!doctype html>
<html>
<head>
  <title>tracking.js - color with camera</title>	
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://fustyles.github.io/webduino/Tracking_20190917/tracking-min.js"></script>
</head>
<body>
<video id="video" width="320" height="240" style="visibility:hidden;position:absolute" preload autoplay loop muted></video>
<canvas id="canvas"></canvas><br>
<table>
<tr>
  <td>Color Name</td>
  <td><input type="text" id="myColor" value="black"></td>
</tr>
<tr>
  <td>R</td>
  <td>min<input type="range" id="myColor_r_min" min="0" max="255" step="1" onchange="myColor_r_min_v.innerHTML=this.value;"><span id="myColor_r_min_v">0</span><br>
	  max<input type="range" id="myColor_r_max" min="0" max="255" step="1" onchange="myColor_r_max_v.innerHTML=this.value;"><span id="myColor_r_max_v">0</span>
  </td>
</tr>
<tr>
  <td>G</td>
  <td>min<input type="range" id="myColor_g_min" min="0" max="255" step="1" onchange="myColor_g_min_v.innerHTML=this.value;"><span id="myColor_g_min_v">0</span><br>
	  max<input type="range" id="myColor_g_max" min="0" max="255" step="1" onchange="myColor_g_max_v.innerHTML=this.value;"><span id="myColor_g_max_v">0</span>
  </td>
</tr>
<tr>
  <td>B</td>
  <td>min<input type="range" id="myColor_b_min" min="0" max="255" step="1" onchange="myColor_b_min_v.innerHTML=this.value;"><span id="myColor_b_min_v">0</span><br>
	  max<input type="range" id="myColor_b_max" min="0" max="255" step="1" onchange="myColor_b_max_v.innerHTML=this.value;"><span id="myColor_b_max_v">0</span>
  </td>
</tr>
</table>
<button id="start" onclick="startDetect();">Start Detection</button>
<div id="result" style="color:red"><div>

  <script>
	var myColor = document.getElementById('myColor');
	var myColor_r_min = document.getElementById('myColor_r_min');
	var myColor_r_max = document.getElementById('myColor_r_max');
	var myColor_g_min = document.getElementById('myColor_g_min');
	var myColor_g_max = document.getElementById('myColor_g_max');
	var myColor_b_min = document.getElementById('myColor_b_min');
	var myColor_b_max = document.getElementById('myColor_b_max');
	var myColor_r_min_v = document.getElementById('myColor_r_min_v');
	var myColor_r_max_v = document.getElementById('myColor_r_max_v');
	var myColor_g_min_v = document.getElementById('myColor_g_min_v');
	var myColor_g_max_v = document.getElementById('myColor_g_max_v');
	var myColor_b_min_v = document.getElementById('myColor_b_min_v');
	var myColor_b_max_v = document.getElementById('myColor_b_max_v');

    document.body.onload = function() {
	  document.getElementById('myColor').value = "black";  // Color List: https://htmlcolorcodes.com/color-names/
	  document.getElementById('myColor_r_min').value = "0";
	  document.getElementById('myColor_r_min_v').innerHTML = "0";
	  document.getElementById('myColor_r_max').value = "20";
	  document.getElementById('myColor_r_max_v').innerHTML = "20";
	  document.getElementById('myColor_g_min').value = "0";
	  document.getElementById('myColor_g_min_v').innerHTML = "0";
	  document.getElementById('myColor_g_max').value = "20";
	  document.getElementById('myColor_g_max_v').innerHTML = "20";
	  document.getElementById('myColor_b_min').value = "0";
	  document.getElementById('myColor_b_min_v').innerHTML = "0";
	  document.getElementById('myColor_b_max').value = "20";
	  document.getElementById('myColor_b_max_v').innerHTML = "20";
	}

    function startDetect() {
      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
	  var result = document.getElementById('result');

      canvas.setAttribute("width", video.width);
      canvas.setAttribute("height", video.height);

      var tracker = new tracking.ColorTracker();

      tracking.track('#video', tracker, { camera: true });

	  var myColor = document.getElementById('myColor').value;
	  var myColor_r_min = document.getElementById('myColor_r_min').value;
	  var myColor_r_max = document.getElementById('myColor_r_max').value;
	  var myColor_g_min = document.getElementById('myColor_g_min').value;
	  var myColor_g_max = document.getElementById('myColor_g_max').value;
	  var myColor_b_min = document.getElementById('myColor_b_min').value;
	  var myColor_b_max = document.getElementById('myColor_b_max').value;

	  tracking.ColorTracker.registerColor('custom', function(r, g, b) {
	    if ((r>=myColor_r_min&&r<=myColor_r_max)&&(g>=myColor_g_min&&g<=myColor_g_max)&&(b>=myColor_b_min&&b<=myColor_b_max)) {
	  	  return true;
	    }
	    return false;
	  });

      tracker.on('track', function(event) {
        context.drawImage(video,0,0,video.width,video.height);
		result.innerHTML = "";

        event.data.forEach(function(rect) {
		  //console.log(rect);
          if (rect.color === 'custom') {
            rect.color = tracker.customColor;
          }

          context.strokeStyle = rect.color;
          context.strokeRect(rect.x, rect.y, rect.width, rect.height);
          //context.font = '11px Helvetica';
          //context.fillStyle = "#fff";
          //context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
          //context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);

		  result.innerHTML+= rect.color+","+rect.x+","+rect.y+","+rect.width+","+rect.height+"<br>";
        });
      });

     initGUIControllers(tracker,myColor);
    };



	function initGUIControllers(tracker,myColor) {

	  var trackedColors = {
		custom: true
	  };

	  Object.keys(tracking.ColorTracker.knownColors_).forEach(function(color) {
		trackedColors[color] = true;
	  });

	  tracker.customColor = myColor;

	  function createCustomColor(value) {
		  console.log(value);
		var components = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(value);
		var customColorR = parseInt(components[1], 16);
		var customColorG = parseInt(components[2], 16);
		var customColorB = parseInt(components[3], 16);

		var colorTotal = customColorR + customColorG + customColorB;

		if (colorTotal === 0) {
		  tracking.ColorTracker.registerColor('custom', function(r, g, b) {
			return r + g + b < 10;
		  });
		} else {
		  var rRatio = customColorR / colorTotal;
		  var gRatio = customColorG / colorTotal;

		  tracking.ColorTracker.registerColor('custom', function(r, g, b) {
			var colorTotal2 = r + g + b;

			if (colorTotal2 === 0) {
			  if (colorTotal < 10) {
				return true;
			  }
			  return false;
			}

			var rRatio2 = r / colorTotal2,
			  gRatio2 = g / colorTotal2,
			  deltaColorTotal = colorTotal / colorTotal2,
			  deltaR = rRatio / rRatio2,
			  deltaG = gRatio / gRatio2;

			return deltaColorTotal > 0.9 && deltaColorTotal < 1.1 &&
			  deltaR > 0.9 && deltaR < 1.1 &&
			  deltaG > 0.9 && deltaG < 1.1;
		  });
		}

		updateColors();
	  }

	  function updateColors() {
		var colors = [];

		for (var color in trackedColors) {
		  if (trackedColors[color]) {
			colors.push(color);
		  }
		}

		tracker.setColors(colors);
	  }

	  updateColors();
	}

	var objectEmit_ = tracking.ObjectTracker.prototype.emit;
	var colorEmit_ = tracking.ColorTracker.prototype.emit;

	tracking.ObjectTracker.prototype.emit = function() {
	  objectEmit_.apply(this, arguments);
	};

	tracking.ColorTracker.prototype.emit = function() {
	  colorEmit_.apply(this, arguments);
	};

  </script>
</body>
</html>
