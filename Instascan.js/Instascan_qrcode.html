<!-- 
Author : ChungYi Fu (Kaohsiung, Taiwan)   2020/10/9 13:00
https://www.facebook.com/francefu
Try it!
https://fustyles.github.io/webduino/Instascan.js/Instascan_qrcode.html
-->

<!DOCTYPE html>
<html>
  <head>
    <title>Instascan</title>
    <script type="text/javascript" src="instascan.min.js"></script>
  </head>
  <body>
	<button onclick="location.href=location.pathname;">Front Camera</button>&nbsp;&nbsp;<button onclick="location.href='?back';">Rear Camera</button><br>
    <video id="preview"></video>
	<div id="result" style="color:red"></div>
    <script type="text/javascript">

	if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
	  console.log("enumerateDevices() not supported.");
	}

	var videoWidth = 320;
	var videoHeight = 240;
	
        var back = 0;
	var userMedia = 0;
	navigator.mediaDevices.enumerateDevices()
		.then(function(devices) {
		  var i=-1;
		  devices.forEach(function(device) {
			  if (device.kind=="videoinput") {
				  i++;
				  if (device.label.includes("facing back")) back=i;
				
			  }
		  });
		
		if (location.search.toLowerCase().indexOf("?back")!=-1) var userMedia = back;
	}) 


      var result = document.getElementById('result');
      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      scanner.addListener('scan', function (content) {
        console.log(utf8to16(content));
		result.innerHTML = utf8to16(content);
      });
      Instascan.Camera.getCameras().then(function (cameras) {
		
        if (cameras.length > 0) {
          scanner.start(cameras[userMedia]);
        } else {
          console.error('No cameras found.');
        }
      }).catch(function (e) {
        console.error(e);
      });
	    
	function utf8to16(str) {
	     var out, i, len, c;
	     var char2, char3;
	     out = "";
	     len = str.length;
	     i = 0;
	     while(i < len) {
		 c = str.charCodeAt(i++);
		 switch(c >> 4)
		 { 
		   case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:
		     // 0xxxxxxx
		     out += str.charAt(i-1);
		     break;
		   case 12: case 13:
		     // 110x xxxx    10xx xxxx
		     char2 = str.charCodeAt(i++);
		     out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
		     break;
		   case 14:
		     // 1110 xxxx   10xx xxxx   10xx xxxx
		     char2 = str.charCodeAt(i++);
		     char3 = str.charCodeAt(i++);
		     out += String.fromCharCode(((c & 0x0F) << 12) |
						    ((char2 & 0x3F) << 6) |
						    ((char3 & 0x3F) << 0));
		     break;
		 }
	     }
	     return out;
	}	    
    </script>
  </body>
</html>
