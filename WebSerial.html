<!--
Web Serial  2021-12-19 16:00
Author : ChungYi Fu (Kaohsiung, Taiwan)
https://www.facebook.com/francefu

Web Serial
https://web.dev/serial/

Try it
https://fustyles.github.io/webduino/WebSerial.html
-->

<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>Web Serial</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
Baud Rate
<select id="baud">
    <option value="9600">9600</option>
    <option value="115200">115200</option>
    <option value="300">300</option>
    <option value="1200">1200</option>
    <option value="2400">2400</option>
    <option value="4800">4800</option>
    <option value="19200">19200</option>
    <option value="38400">38400</option>
    <option value="57600">57600</option>
    <option value="74880">74880</option>
    <option value="230400">230400</option>
    <option value="250000">250000</option>
    <option value="500000">500000</option>
    <option value="1000000">1000000</option>	
    <option value="2000000">2000000</option>		
</select><br><br>
<button id="request-port">Select Port</button>
<button id="close-port">Close Board</button><br><br>
<input type="text" id="command"><button id="send">Send</button><br>
<span id="status"></span>
<script>
  
let port = null;
let textEncoder = {};
let writableStreamClosed = {};
let writer = {};
let reader = null;
let readSting = "";
let keepReading = true;
let selProductId = "";
let selVendorId = "";

let baud = document.getElementById('baud');
let command = document.getElementById('command');
let status = document.getElementById('status');
let buttonRequest = document.getElementById('request-port');
let buttonClose = document.getElementById('close-port');
let send = document.getElementById('send');	

navigator.serial.addEventListener("connect", (event) => {
  status.innerHTML = "connect";
});

navigator.serial.addEventListener("disconnect", (event) => {
  status.innerHTML = "disconnect";
});	
			
async function readUntilClosed() {
  while (port.readable && keepReading) {
	reader = port.readable.getReader();
	try {
	  while (true) {
		const { value, done } = await reader.read();
		if (done) {
		  // |reader| has been canceled.
		  break;
		}
		if (value) {
			readSting = new TextDecoder().decode(value);
			console.log(readSting);
			status.innerHTML = readSting;
		}
	  }
	} catch (error) {
	  // Handle |error|...
	} finally {
	  reader.releaseLock();
	}
  }
}

buttonRequest.addEventListener('click', async () => {

	if ("serial" in navigator) {
		/*
		const filters = [
			{ usbVendorId: 0x2341, usbProductId: 0x0043 },
			{ usbVendorId: 0x2341, usbProductId: 0x0001 }
		];
		*/
		const filters = [];
		
		port = await navigator.serial.requestPort({ filters });
		const { usbProductId, usbVendorId } = port.getInfo();
		selProductId = usbProductId;
		selVendorId = usbVendorId;
		
		keepReading = true;
		
		try {
			var rate =  Number(baud.value);
			await port.open({ baudRate: rate });
			status.innerHTML = "VendorId: 0x"+selVendorId.toString(16)+" ProductId: 0x"+selProductId.toString(16)+" Ready!";
			
			//await port.setSignals({ dataTerminalReady: false });
			//await new Promise(resolve => setTimeout(resolve, 200));
			//await port.setSignals({ dataTerminalReady: true });			
			
			textEncoder[selProductId] = new TextEncoderStream();
			writableStreamClosed[selProductId] = textEncoder[selProductId].readable.pipeTo(port.writable);
			writer[selProductId] = textEncoder[selProductId].writable.getWriter();			
			
			const closed = readUntilClosed();
		} catch (error) {
			var errorString = error.message;
			if (errorString.indexOf("already open")!=-1) {
				status.innerHTML = "VendorId: 0x"+selVendorId.toString(16)+" ProductId: 0x"+selProductId.toString(16)+" Ready!";
			}
			else if (errorString.indexOf("Failed to open serial port")!=-1) {
				setTimeout(function(){buttonRequest.click();},1000);
			}
			else {
				status.innerHTML = errorString;
			}
		}
	}
		
});

buttonClose.addEventListener('click', async () => {
	try {
		if (port) {	
			/*
			keepReading = false;
			reader.cancel();
			await closed;
			*/
			
			port.close();
			port = null;
			status.innerHTML = "closed";
		}
	} catch (error) {
			status.innerHTML = error.message;
	}	
});

send.addEventListener('click', async () => {
	if (port&&writer) {
		try {	
			await writer[selProductId].write(command.value);
		} catch (error) {
			status.innerHTML = error.message;
		}
	}
});
</script>
</body>
</html>
